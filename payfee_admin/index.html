<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | School Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal { backdrop-filter: blur(4px); }
        /* Style for the new preview scrollbar */
        .preview-scroll::-webkit-scrollbar { width: 6px; }
        .preview-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="login-view" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Admin Panel</h1>
                <p class="text-gray-500 mt-2">School Management System</p>
            </div>
            <div id="login-message" class="hidden p-3 mb-4 text-sm rounded-lg"></div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="login-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-300">
                    <span id="login-btn-text">Sign In</span>
                </button>
            </form>
        </div>
    </div>

    <div id="admin-view" class="hidden">
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                    <p class="text-sm text-gray-500">Manage students and records</p>
                </div>
                <div class="flex items-center gap-4">
                    <span id="admin-email" class="text-sm text-gray-600"></span>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-indigo-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Total Students</p>
                            <p id="total-students" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Total Collected</p>
                            <p id="total-collected" class="text-2xl font-bold text-gray-800">â‚¹0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-500">Total Pending</p>
                            <p id="total-pending" class="text-2xl font-bold text-gray-800">â‚¹0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-4 mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="relative flex-1 w-full sm:w-auto">
                    <input type="text" id="search-input" placeholder="Search by name or roll number..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 absolute left-3 top-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                    <input type="file" id="import-excel-input" accept=".xlsx, .xls" class="hidden" onchange="handleImportPreview(event)">
                    <button onclick="document.getElementById('import-excel-input').click()" class="flex-1 sm:flex-none bg-amber-600 hover:bg-amber-700 text-white font-bold px-6 py-2 rounded-lg transition duration-300 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Import Excel
                    </button>
                    <button onclick="exportToExcel()" class="flex-1 sm:flex-none bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-2 rounded-lg transition duration-300 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Export Excel
                    </button>
                    <button onclick="openAddStudentModal()" class="flex-1 sm:flex-none bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-2 rounded-lg transition duration-300 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Student
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roll No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Fee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="import-preview-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 modal flex items-center justify-center p-4 z-[60]">
        <div class="bg-white rounded-xl w-full max-w-5xl max-h-[85vh] flex flex-col shadow-2xl">
            <div class="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <div>
                    <h2 class="text-xl font-bold text-indigo-900">Import Students Preview</h2>
                    <p class="text-sm text-indigo-700">Records in red already exist in your database (matching Phone & Father's Name).</p>
                </div>
                <button onclick="closeImportPreview()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto preview-scroll flex-1">
                <table class="min-w-full border">
                    <thead class="bg-gray-100 sticky top-0 shadow-sm">
                        <tr>
                            <th class="p-3 text-left text-xs font-bold uppercase text-gray-600">Status</th>
                            <th class="p-3 text-left text-xs font-bold uppercase text-gray-600">Student Name</th>
                            <th class="p-3 text-left text-xs font-bold uppercase text-gray-600">Father's Name</th>
                            <th class="p-3 text-left text-xs font-bold uppercase text-gray-600">Phone</th>
                            <th class="p-3 text-left text-xs font-bold uppercase text-gray-600">Class</th>
                            <th class="p-3 text-center text-xs font-bold uppercase text-gray-600">Action</th>
                        </tr>
                    </thead>
                    <tbody id="import-preview-body"></tbody>
                </table>
            </div>
            <div class="p-6 border-t flex justify-end gap-3 bg-gray-50 rounded-b-xl">
                <button onclick="closeImportPreview()" class="px-6 py-2 border rounded-lg hover:bg-white transition">Cancel</button>
                <button id="final-upload-btn" onclick="processFinalUpload()" class="px-8 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg transition">
                    Finalize Upload
                </button>
            </div>
        </div>
    </div>

    <div id="loading-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 modal flex items-center justify-center p-4 z-[70]">
        <div class="bg-white rounded-lg p-8 text-center max-w-xs w-full shadow-2xl">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mx-auto mb-4"></div>
            <p class="text-gray-700 font-medium" id="loading-text">Saving to Database...</p>
        </div>
    </div>

    <div id="student-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 modal flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Add New Student</h2>
                <button onclick="closeStudentModal()" class="text-gray-400 hover:text-gray-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="student-form" class="p-6 space-y-6">
                <input type="hidden" id="student-key">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                        <input type="text" id="student-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Father's Name</label>
                        <input type="text" id="student-father-name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Roll Number (Auto-Generated) *</label>
                        <input type="text" id="student-rollno" required readonly class="w-full p-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Class *</label>
                        <input type="text" id="student-class" required placeholder="e.g., Class 10-A" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone No.</label>
                        <input type="tel" id="student-phone" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email ID</label>
                        <input type="email" id="student-email" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                        <textarea id="student-address" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Photo URL</label>
                        <input type="url" id="student-photo" placeholder="https://example.com/photo.jpg" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Fee Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total Fee (â‚¹) *</label>
                            <input type="number" id="fee-total" required min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Paid Amount (â‚¹) *</label>
                            <input type="number" id="fee-paid" required min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Due Date *</label>
                            <input type="date" id="fee-duedate" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Attendance</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Present Days *</label>
                            <input type="number" id="att-present" required min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Absent Days *</label>
                            <input type="number" id="att-absent" required min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total Days *</label>
                            <input type="number" id="att-total" required min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gray-700">Academic Performance</h3>
                        <button type="button" onclick="addSubjectRow()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Subject
                        </button>
                    </div>
                    <div id="subjects-container" class="space-y-2"></div>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeStudentModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-300">Cancel</button>
                    <button type="submit" id="submit-btn" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition duration-300">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 modal flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">Delete Student</h3>
                <p class="text-sm text-gray-500 mb-6">Are you sure you want to delete this student? This action cannot be undone.</p>
                <div class="flex space-x-3">
                    <button onclick="closeDeleteModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-300">Cancel</button>
                    <button onclick="confirmDelete()" id="confirm-delete-btn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-300">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, get, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

        // Firebase Config - ORIGINAL
        const firebaseConfig = {
            apiKey: "AIzaSyDJfzkrdZqHWi0y9OTPQ-IpaJbA8JJkRSg",
            authDomain: "paymcs-371be.firebaseapp.com",
            databaseURL: "https://paymcs-371be-default-rtdb.firebaseio.com/",
            projectId: "paymcs-371be",
            storageBucket: "paymcs-371be.firebasestorage.app",
            messagingSenderId: "676822362839",
            appId: "1:676822362839:web:cc55be2492db86b5469e92"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let allStudents = {};
        let studentToDelete = null;
        let currentUser = null;
        let pendingImportData = []; 

        // DOM Elements - ORIGINAL
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const loginForm = document.getElementById('login-form');
        const loginMessage = document.getElementById('login-message');
        const studentModal = document.getElementById('student-modal');
        const deleteModal = document.getElementById('delete-modal');
        const studentForm = document.getElementById('student-form');
        const searchInput = document.getElementById('search-input');
        const loginBtn = document.getElementById('login-btn');
        const loginBtnText = document.getElementById('login-btn-text');
        const studentNameInput = document.getElementById('student-name');
        const studentPhoneInput = document.getElementById('student-phone');

        // --- ENHANCED IMPORT SYSTEM ---

        // Intelligent Header Matching
        function findValue(row, keywords) {
            const keys = Object.keys(row);
            for (let key of keys) {
                const lowerKey = key.toLowerCase().replace(/[^a-z0-9]/g, '');
                if (keywords.some(kw => lowerKey.includes(kw))) {
                    return row[key];
                }
            }
            return null;
        }

        window.handleImportPreview = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    if (json.length === 0) {
                        showNotification('Excel file is empty', 'error');
                        return;
                    }

                    // Process incoming data to map related text to correct fields
                    pendingImportData = json.map(row => {
                        return {
                            raw: row,
                            mapped: {
                                name: findValue(row, ['name', 'studentname', 'fullname', 'stname']),
                                father: findValue(row, ['father', 'parent', 'dad', 'guardian']),
                                phone: findValue(row, ['phone', 'mobile', 'contact', 'cell', 'tel', 'whatsapp']),
                                class: findValue(row, ['class', 'grade', 'standard', 'sec']),
                                totalFee: findValue(row, ['totalfee', 'fees', 'amount', 'payable']),
                                paid: findValue(row, ['paid', 'received', 'deposite']),
                                address: findValue(row, ['address', 'location', 'city', 'area']),
                                email: findValue(row, ['email', 'mailid'])
                            }
                        };
                    });

                    renderImportPreview();
                    document.getElementById('import-preview-modal').classList.remove('hidden');
                    event.target.value = ''; 
                } catch (err) {
                    showNotification('Invalid Excel format', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        };

        function renderImportPreview() {
            const body = document.getElementById('import-preview-body');
            body.innerHTML = '';

            pendingImportData.forEach((item, index) => {
                const phone = String(item.mapped.phone || "");
                const father = String(item.mapped.father || "").trim().toLowerCase();
                
                // DUPLICATE CHECK
                const isDuplicate = Object.values(allStudents).some(s => 
                    String(s.phone) === phone && String(s.fatherName || "").trim().toLowerCase() === father
                );

                const tr = document.createElement('tr');
                tr.className = `border-b hover:bg-gray-50 ${isDuplicate ? 'bg-red-50' : ''}`;
                tr.innerHTML = `
                    <td class="p-3 text-xs">
                        ${isDuplicate ? 
                            '<span class="bg-red-100 text-red-700 px-2 py-1 rounded font-bold">Duplicate</span>' : 
                            '<span class="bg-green-100 text-green-700 px-2 py-1 rounded font-medium">New</span>'}
                    </td>
                    <td class="p-3 text-sm font-semibold text-gray-800">${item.mapped.name || 'N/A'}</td>
                    <td class="p-3 text-sm text-gray-600">${item.mapped.father || 'N/A'}</td>
                    <td class="p-3 text-sm text-gray-600">${item.mapped.phone || 'N/A'}</td>
                    <td class="p-3 text-sm text-gray-600">${item.mapped.class || 'N/A'}</td>
                    <td class="p-3 text-center">
                        <button onclick="removeFromImportList(${index})" class="text-red-500 hover:text-red-700 font-bold p-1 transition">Remove</button>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        window.removeFromImportList = (index) => {
            pendingImportData.splice(index, 1);
            if (pendingImportData.length === 0) closeImportPreview();
            else renderImportPreview();
        };

        window.closeImportPreview = () => {
            document.getElementById('import-preview-modal').classList.add('hidden');
            pendingImportData = [];
        };

        window.processFinalUpload = async () => {
            if (!currentUser || pendingImportData.length === 0) return;
            const loadModal = document.getElementById('loading-modal');
            loadModal.classList.remove('hidden');
            
            try {
                let count = 0;
                for (const item of pendingImportData) {
                    const row = item.mapped;
                    if (!row.name || !row.class) continue;

                    const phone = String(row.phone || "");
                    const father = String(row.father || "").trim().toLowerCase();
                    
                    // Determine if student exists to overwrite OR create new key
                    let existingKey = null;
                    for (const [key, s] of Object.entries(allStudents)) {
                        if (String(s.phone) === phone && String(s.fatherName || "").trim().toLowerCase() === father) {
                            existingKey = key;
                            break;
                        }
                    }

                    const studentKey = existingKey || ('student_' + Date.now() + Math.floor(Math.random() * 1000));
                    const total = parseFloat(row.totalFee) || 0;
                    const paid = parseFloat(row.paid) || 0;
                    
                    // Maintain roll number if updating, else generate
                    const rollNo = existingKey ? allStudents[existingKey].rollNo : generateImportRollNo(String(row.name), String(row.phone || "000"));

                    // Requirement: Add 2 random subjects with 0 marks and Grade A
                    const defaultSubjects = [
                        { name: "General Knowledge", marks: 0, grade: "A" },
                        { name: "Social Activity", marks: 0, grade: "A" }
                    ];

                    const studentData = {
                        name: String(row.name),
                        fatherName: String(row.father || ""),
                        rollNo: rollNo,
                        class: String(row.class),
                        phone: String(row.phone || ""),
                        email: String(row.email || ""),
                        address: String(row.address || ""),
                        photo: `https://api.dicebear.com/7.x/avataaars/svg?seed=${row.name}`,
                        fees: {
                            total: total, paid: paid, pending: total - paid,
                            dueDate: new Date().toISOString().split('T')[0]
                        },
                        attendance: { present: 0, absent: 0, total: 0, percentage: 0 },
                        subjects: defaultSubjects
                    };

                    await set(ref(db, `students/${studentKey}`), studentData);
                    count++;
                }
                
                loadModal.classList.add('hidden');
                closeImportPreview();
                showNotification(`Successfully imported/updated ${count} students.`, 'success');
            } catch (err) {
                console.error(err);
                loadModal.classList.add('hidden');
                showNotification('Error during upload', 'error');
            }
        };

        // --- ALL ORIGINAL FUNCTIONS ---

        function generateImportRollNo(name, phone) {
            const namePart = name.substring(0, 2).toUpperCase();
            const phonePart = phone.substring(0, 3);
            let isUnique = false;
            let roll = '';
            while (!isUnique) {
                const suffix = Math.floor(10 + Math.random() * 89);
                roll = `${namePart}${phonePart}${suffix}`;
                if (!Object.values(allStudents).some(s => s.rollNo === roll)) isUnique = true;
            }
            return roll;
        }

        window.exportToExcel = () => {
            if (Object.keys(allStudents).length === 0) {
                showNotification('No data to export', 'error');
                return;
            }
            const dataToExport = Object.values(allStudents).map(student => ({
                "Name": student.name, "Father's Name": student.fatherName || '', "Roll Number": student.rollNo,
                "Class": student.class, "Phone": student.phone || '', "Email": student.email || '',
                "Address": student.address || '', "Total Fee": student.fees.total, "Paid": student.fees.paid,
                "Fee Due Date": student.fees.dueDate, "Present": student.attendance.present, "Absent": student.attendance.absent
            }));
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Students");
            XLSX.writeFile(workbook, `Student_Report_${new Date().toLocaleDateString()}.xlsx`);
            showNotification('Excel file exported!', 'success');
        };

        function generateAutoRollNumber() {
            if (document.getElementById('student-key').value !== '') return;
            const name = studentNameInput.value.trim();
            const phone = studentPhoneInput.value.trim();
            if (name.length < 2 || phone.length < 3) return;
            const namePart = name.substring(0, 2).toUpperCase();
            const phonePart = phone.substring(0, 3);
            let isUnique = false;
            let generatedRollNo = '';
            while (!isUnique) {
                const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                const numbers = "0123456789";
                const randLetter = letters.charAt(Math.floor(Math.random() * letters.length));
                const randNumber = numbers.charAt(Math.floor(Math.random() * numbers.length));
                const suffix = Math.random() > 0.5 ? (randLetter + randNumber) : (randNumber + randLetter);
                generatedRollNo = `${namePart}${phonePart}${suffix}`;
                const exists = Object.values(allStudents).some(student => student.rollNo === generatedRollNo);
                if (!exists) isUnique = true;
            }
            document.getElementById('student-rollno').value = generatedRollNo;
        }

        studentNameInput.addEventListener('input', generateAutoRollNumber);
        studentPhoneInput.addEventListener('input', generateAutoRollNumber);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('admin-email').textContent = user.email;
                loginView.classList.add('hidden');
                adminView.classList.remove('hidden');
                loadStudents();
            } else {
                currentUser = null;
                adminView.classList.add('hidden');
                loginView.classList.remove('hidden');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginBtn.disabled = true;
            loginBtnText.textContent = 'Signing in...';
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;
            } catch (error) {
                showLoginMessage('error', 'Invalid credentials');
                loginBtn.disabled = false;
                loginBtnText.textContent = 'Sign In';
            }
        });

        function showLoginMessage(type, message) {
            loginMessage.textContent = message;
            loginMessage.className = 'p-3 mb-4 text-sm rounded-lg ' + (type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
            loginMessage.classList.remove('hidden');
        }

        window.logout = async () => { await signOut(auth); loginMessage.classList.add('hidden'); };

        async function loadStudents() {
            if (!currentUser) return;
            const studentsRef = ref(db, 'students');
            onValue(studentsRef, (snapshot) => {
                allStudents = snapshot.exists() ? snapshot.val() : {};
                renderStudents(allStudents);
                updateStats();
            });
        }

        function renderStudents(students) {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '';
            if (Object.keys(students).length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-gray-500">No students found.</td></tr>`;
                return;
            }
            for (const [key, student] of Object.entries(students)) {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';
                const pending = (student.fees.total || 0) - (student.fees.paid || 0);
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <img class="h-10 w-10 rounded-full object-cover" src="${student.photo || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + student.name}">
                            <div class="ml-4"><div class="text-sm font-medium text-gray-900">${student.name}</div></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.rollNo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${student.class}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">â‚¹${(student.fees.total || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">â‚¹${(student.fees.paid || 0).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${pending > 0 ? 'text-red-600' : 'text-green-600'} font-medium">â‚¹${pending.toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button onclick="window.editStudent('${key}')" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                        <button onclick="window.deleteStudent('${key}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
            }
        }

        function updateStats() {
            const students = Object.values(allStudents);
            document.getElementById('total-students').textContent = students.length;
            document.getElementById('total-collected').textContent = 'â‚¹' + students.reduce((sum, s) => sum + (s.fees.paid || 0), 0).toLocaleString();
            document.getElementById('total-pending').textContent = 'â‚¹' + students.reduce((sum, s) => sum + ((s.fees.total || 0) - (s.fees.paid || 0)), 0).toLocaleString();
        }

        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = {};
            for (const [key, student] of Object.entries(allStudents)) {
                if (student.name.toLowerCase().includes(searchTerm) || student.rollNo.toLowerCase().includes(searchTerm)) filtered[key] = student;
            }
            renderStudents(filtered);
        });

        window.openAddStudentModal = () => {
            document.getElementById('modal-title').textContent = 'Add New Student';
            document.getElementById('student-key').value = '';
            studentForm.reset();
            document.getElementById('subjects-container').innerHTML = '';
            addSubjectRow(); addSubjectRow();
            document.getElementById('student-rollno').value = ''; 
            studentModal.classList.remove('hidden');
        };

        window.closeStudentModal = () => studentModal.classList.add('hidden');

        window.editStudent = (key) => {
            const student = allStudents[key];
            document.getElementById('modal-title').textContent = 'Edit Student';
            document.getElementById('student-key').value = key;
            document.getElementById('student-name').value = student.name;
            document.getElementById('student-father-name').value = student.fatherName || ''; 
            document.getElementById('student-rollno').value = student.rollNo;
            document.getElementById('student-class').value = student.class;
            document.getElementById('student-phone').value = student.phone || ''; 
            document.getElementById('student-email').value = student.email || ''; 
            document.getElementById('student-address').value = student.address || ''; 
            document.getElementById('student-photo').value = student.photo || '';
            document.getElementById('fee-total').value = student.fees.total;
            document.getElementById('fee-paid').value = student.fees.paid;
            document.getElementById('fee-duedate').value = student.fees.dueDate;
            document.getElementById('att-present').value = student.attendance.present;
            document.getElementById('att-absent').value = student.attendance.absent;
            document.getElementById('att-total').value = student.attendance.total;
            document.getElementById('subjects-container').innerHTML = '';
            if (student.subjects) student.subjects.forEach(subject => addSubjectRow(subject));
            studentModal.classList.remove('hidden');
        };

        window.deleteStudent = (key) => { studentToDelete = key; deleteModal.classList.remove('hidden'); };
        window.closeDeleteModal = () => { deleteModal.classList.add('hidden'); studentToDelete = null; };
        window.confirmDelete = async () => {
            if (!studentToDelete || !currentUser) return;
            await remove(ref(db, `students/${studentToDelete}`));
            closeDeleteModal();
            showNotification('Student deleted', 'success');
        };

        window.addSubjectRow = (subject = null) => {
            const container = document.getElementById('subjects-container');
            const row = document.createElement('div');
            row.className = 'flex gap-2 items-center';
            row.innerHTML = `
                <input type="text" placeholder="Subject" value="${subject ? subject.name : ''}" required class="flex-1 p-2 border rounded-lg subject-name">
                <input type="number" placeholder="Marks" value="${subject ? subject.marks : ''}" required class="w-24 p-2 border rounded-lg subject-marks">
                <input type="text" placeholder="Grade" value="${subject ? subject.grade : ''}" required class="w-20 p-2 border rounded-lg subject-grade">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-600 p-2">ðŸ—‘</button>`;
            container.appendChild(row);
        };

        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            const subjects = [];
            document.querySelectorAll('#subjects-container > div').forEach(row => {
                const name = row.querySelector('.subject-name').value;
                const marks = parseInt(row.querySelector('.subject-marks').value);
                const grade = row.querySelector('.subject-grade').value;
                if (name && !isNaN(marks)) subjects.push({ name, marks, grade });
            });
            if (subjects.length < 2) {
                showNotification('Add at least 2 subjects', 'error');
                submitBtn.disabled = false;
                return;
            }
            const studentKey = document.getElementById('student-key').value || 'student_' + Date.now();
            const totalFee = parseFloat(document.getElementById('fee-total').value);
            const paidFee = parseFloat(document.getElementById('fee-paid').value);
            const present = parseInt(document.getElementById('att-present').value);
            const total = parseInt(document.getElementById('att-total').value);
            const studentData = {
                name: document.getElementById('student-name').value,
                fatherName: document.getElementById('student-father-name').value, 
                rollNo: document.getElementById('student-rollno').value,
                class: document.getElementById('student-class').value,
                phone: document.getElementById('student-phone').value, 
                email: document.getElementById('student-email').value, 
                address: document.getElementById('student-address').value, 
                photo: document.getElementById('student-photo').value || `https://api.dicebear.com/7.x/avataaars/svg?seed=${document.getElementById('student-name').value}`,
                fees: { total: totalFee, paid: paidFee, pending: totalFee - paidFee, dueDate: document.getElementById('fee-duedate').value },
                attendance: { present, absent: parseInt(document.getElementById('att-absent').value), total, percentage: Math.round((present / total) * 100) },
                subjects: subjects
            };
            await set(ref(db, `students/${studentKey}`), studentData);
            closeStudentModal();
            showNotification('Student saved', 'success');
            submitBtn.disabled = false;
        });

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-[100] p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 3000);
        }
    </script>
</body>
</html>
